<!--Shopping list page-->
<!DOCTYPE html>
<html>
    <head>
        <title>Shopping List - Food Database</title> <!--The title that appears in the tab-->
        <link rel="icon" type="image/x-icon" href="/c/favicon.ico"> <!--I can add an icon later easily by doing this-->
        <link rel="stylesheet" href="/c/style.css"> <!--Link to the CSS file-->
        <script src="/c/include.js"></script> <!--Embeds the script for HTML includes in the page-->
        <script src="/dbc/dbglobal.js"></script>
        <script>
            async function submitForm(form) {
                const item = {
                    name:form['name'].value,
                    qty:form['qty'].value,
                    unit:form['unit'].value
                }
                await addItem(item, 'shoppingList', console.log);
                loadItems();
                return false 
            }
            async function loadItems() {
                const items = await getAllItems("shoppingList");
                const list = [];
                for(x in items) {
                    item = items[x];
                    //Creating a list item    
                    list.push(
                    "<li>" +
                        "<div>"+item.name+"</div>" +
                        "<div>" +
                            item.qty+item.unit+" <button data-type='major' onclick='check("+x+")'>Remove</button>" +
                        "</div>" +
                    "</li>");
                };
                document.getElementById('output').innerHTML = list;
            };
            async function check(key) { //Removing an item from the list
                await removeItem(key, 'shoppingList');
                loadItems(); //Refresh the list once complete
            }
            async function addAllToFridge() {
                const items = await getAllItems('shoppingList'); //Get the shopping list
                console.log(items);
                const promise = addArray(items, 'foodStore'); //Add to the fridge
                console.log(2);
                promise.then(
                    async () => { 
                        const transaction = await getTrans('shoppingList', true);
                        transaction.oncomplete = (event) => loadItems(); //Refreshes the list when complete.
                        for (key in items) {
                            transaction
                                .objectStore('shoppingList')
                                .delete(Number(key))//Deletes each item
                                .onsuccess = (event) => console.log(event.target.result);
                        }
                    },
                    (error) => {
                        console.log('error');
                        window.alert("Something went wrong. Error code: " + error);
                    }
                )
                
            }
        </script>
    </head>
    <body>
        <nav id="main" class="cf include-html" data-include-src="/c/navbar.html">
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/database/food.html">Fridge</a></li>
                <li><a href="/database/recipes.html">Recipes</a></li>
                <li><a href="/database/shopping.html">Shopping List</a></li>
                <li><a href="/help.html">Help</a></li>            
            </ul>
        </nav>
        <h1>Shopping List</h1>
        <form class="cf" onsubmit="event.preventDefault(); submitForm(this)">
            <div><!--Will be used to separate different parts of the form-->
                <label for="name">Name: </label>
                <input type="text" name="name" id="name">
            </div><div>
                <label for="qty">Amount: </label>
                <input type="number" name="qty" id="qty" min="0">
                <select id="unit" name="unit">
                    <option value=""></option>
                    <option value="g">g</option>
                    <option value="kg">kg</option>
                    <option value="L">L</option>
                </select> 
            </div>
            <input type="submit" value="Add Item">
            <input type="reset" value="Clear" data-float="right">
        </form>
        <div class="form">
            <button data-type="minor" onclick="addAllToFridge()">Add all to fridge</button>
        </div>

        <ul id="output"><!--The list of items in the shopping list-->
        </ul>
        <script>
            loadItems();
        </script>
        
        <footer class="cf include-html" data-include-src="/c/footer.html">
            <nav>
                <ul>
                    <li><a href="/index.html">Home</a></li>
                    <li><a href="/database/food.html">Fridge</a></li>
                    <li><a href="/database/recipes.html">Recipes</a></li>
                    <li><a href="/database/shopping.html">Shopping List</a></li>
                    <li><a href="/help.html">Help</a></li>
                </ul>
            </nav>
            <p class="right">
                Â©Oliver Glossop, 2023
            </p>
        </footer>
        <script>
            includeHTML();
        </script>
    </body>
</html>