<!--List of recipes-->
<!DOCTYPE html>
<html>
    <head>
        <title>Edit Recipe - Food Database</title> <!--The title that appears in the tab-->
        <link rel="icon" type="image/x-icon" href="/c/favicon.ico"> <!--I can add an icon later easily by doing this-->
        <link rel="stylesheet" href="/c/style.css"> <!--Link to the CSS file-->
        <script src="/c/include.js"></script> <!--Embeds the script for HTML includes in the page-->
        <script src="/dbc/dbglobal.js"></script>
        <script>
            //Getting the key to load from the URL
            let query = new URLSearchParams(window.location.search); //Gets the URL parameters of the page
            let key = Number(query.get('key')); //Gets the 'key' parameter as a number
            console.log(key);
            
            var recipe; //Global variable, so that the ingredient list doesn't have to be reloaded each time
            var ready = false; //Used by removeIngredient, to ensure that the correct ingredient is removed.

            async function getRecipe() { 
                recipe = await getItem(key, 'recipeStore');
            }
            recipePromise = getRecipe(); //recipePromise holds a promise which is fulfilled when getRecipe is complete
            
            async function loadItems() {
                await recipePromise; 
                const items = recipe.ingredients;
                
                const list = [];
                if (items.length) { //Checking if there are items in the array
                    for(x in items) {
                        item = items[x]
                        
                        if (item) { //Checking if the value is undefined
                            list.push(
                            "<li>" +
                                "<div>"+item.name+"</div>" +
                                "<div>" +
                                    item.qty+item.unit+" <button data-type='major' onclick='removeIngredient("+x+")'>Remove</button>" +
                                "</div>" +
                            "</li>");
                        }
                    }
                }
                document.getElementById('output').innerHTML = list;
                ready = true; //Marks that removeItem can be called again
            };
            async function loadText() { //Loading the text from the database
                await recipePromise;
                document.getElementById('recipe-editor').innerHTML = recipe.text;
            }

            async function addIngredient(form) {
                await recipePromise; //Wait for the recipe to be loaded
                const item = {
                    name:form['name'].value,
                    qty:form['qty'].value,
                    unit:form['unit'].value
                }
                recipe.ingredients.push(item); //Adds the item to the list of ingredients.
                await updateItem(key, recipe, 'recipeStore'); //Wait until the item is added
                loadItems(); //Reload the list of ingredients
                return false 
            }
            async function removeIngredient(index) { //Removing an item from the list
                if (ready) { //Makes sure that the list is reloaded before more elements are removed
                    ready = false; //This function can not be called again until 
                    recipe.ingredients.splice(index, 1); //Removes the item from the array without leaving an empty space.
                    console.log(recipe.ingredients);

                    await updateItem(key, recipe, 'recipeStore');
                    loadItems();
                } //The 'ready' variable will be set again by the loadItems function
            }
            
            async function saveText(form) {
                await recipePromise;
                recipe.text = form['text'].value; //Gets the text from the form
                updateItem(key, recipe, 'recipeStore');
            }
        </script>
    </head>
    <body>
        <nav id="main" class="cf include-html" data-include-src="/c/navbar.html">
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/database/food.html">Fridge</a></li>
                <li><a href="/database/recipes.html">Recipes</a></li>
                <li><a href="/database/shopping.html">Shopping List</a></li>
                <li><a href="/help.html">Help</a></li>            
            </ul>
        </nav>
        <h1>Edit Recipe</h1>
        <div data-cf class="grid-2"><!--Container for the recipe editor and ingredient list-->
            <div>
                <form onsubmit="event.preventDefault(); saveText(this)">
                    <label for="recipe-editor">Recipe</label>
                    <textarea id="recipe-editor" name="text"></textarea>
                    <input type="submit" value="Save">
                    <input type="reset" value="Clear"  onclick="document.getElementById('recipe-editor').innerHTML = '';">
                </form>
            </div><div>
                <form onsubmit="event.preventDefault(); addIngredient(this)" data-cf>
                    <div><!--Will be used to separate different parts of the form-->
                        <label for="name">Name: </label>
                        <input type="text" name="name" id="name">
                    </div><div>
                        <label for="qty">Amount: </label>
                        <input type="number" name="qty" id="qty" min="0">
                        <select id="unit" name="unit">
                            <option value=""></option>
                            <option value="g">g</option>
                            <option value="kg">kg</option>
                            <option value="L">L</option>
                        </select> 
                    </div>
                    <input type="submit" value="Add Item">
                    <input type="reset" value="Clear" data-float="right">
                </form>

                <ul id="output"><!--The list of items in the fridge-->
                    <!--Add loading animation-->
                </ul>
            </div>
            <script>
                loadItems();
                loadText();
            </script>
        </div>
        <footer class="cf include-html" data-include-src="/c/footer.html">
            <nav>
                <ul>
                    <li><a href="/index.html">Home</a></li>
                    <li><a href="/database/food.html">Fridge</a></li>
                    <li><a href="/database/recipes.html">Recipes</a></li>
                    <li><a href="/database/shopping.html">Shopping List</a></li>
                    <li><a href="/help.html">Help</a></li>
                </ul>
            </nav>
            <p class="right">
                Â©Oliver Glossop, 2023
            </p>
        </footer>
        <script>
            includeHTML();
        </script>
    </body>
</html>