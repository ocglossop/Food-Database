<!--List of recipes-->
<!DOCTYPE html>
<html>
    <head>
        <title>Edit Recipe - Food Database</title> <!--The title that appears in the tab-->
        <link rel="icon" type="image/x-icon" href="/c/favicon.ico"> <!--I can add an icon later easily by doing this-->
        <link rel="stylesheet" href="/c/style.css"> <!--Link to the CSS file-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="/c/include.js"></script> <!--Embeds the script for HTML includes in the page-->
        <script src="/dbc/dbglobal.js"></script>
        <script>
            var recipe; //Global variable, so that the ingredient list doesn't have to be reloaded each time
            var ready = false; //Used by removeIngredient, to ensure that the correct ingredient is removed.
            let key;

            async function getRecipe() { 
                recipe = await getItem(key, 'recipeStore');
            }

            //Getting the key to load from the URL
            let query = new URLSearchParams(window.location.search); //Gets the URL parameters of the page
            

            if (query.get('new-name') & !query.get('key')) { //If a new recipe is made, and no key is sent
                recipe = {name:query.get('new-name'), text:'', ingredients:[]}; //Adds the name to the recipe
                recipePromise = addItem(recipe, 'recipeStore');
                recipePromise.then((value) => {key = value;}); //Get the key for the new recipe
                console.log('New recipe created.');
            } else {
                key = Number(query.get('key')); //Gets the 'key' parameter as a number
                recipePromise = getRecipe(); //recipePromise holds a promise which is fulfilled when getRecipe is complete
            }
            
            async function loadItems() {
                await recipePromise; 
                const items = recipe.ingredients;
                
                let list = '';
                if (items.length) { //Checking if there are items in the array
                    for(x in items) {
                        item = items[x];
                        if (item) { //Checking if the value is undefined
                            list += (
                                "<li>" +
                                    "<label class='check-container'>" +
                                        item.name +
                                        "<input type='checkbox' form='list' name="+x+">" +
                                        "<span class='checkmark'></span>" +
                                    "</label>" +
                                    item.qty+" "+item.unit +
                                "</li>");
                        }
                    }
                }
                document.getElementById('output').innerHTML = list;
                ready = true; //Marks that removeItem can be called again
            };
            async function loadText() { //Loading the name and text from the database
                await recipePromise;
                document.getElementById('recipe-editor').innerHTML = recipe.text;
                document.getElementById('recipe-name').innerHTML = recipe.name; //Puts the name in the heading
            }

            async function addIngredient(form) {
                await recipePromise; //Wait for the recipe to be loaded
                const item = {
                    name:form['name'].value,
                    qty:form['qty'].value,
                    unit:form['unit'].value
                }
                recipe.ingredients.push(item); //Adds the item to the list of ingredients.
                await updateItem(key, recipe, 'recipeStore'); //Wait until the item is added
                loadItems(); //Reload the list of ingredients
                form.reset(); //Clears the form after adding an ingredient
                return false 
            }
            async function removeIngredient(index) { //Removing an item from the list
                if (ready) { //Makes sure that the list is reloaded before more elements are removed
                    ready = false; //This function can not be called again until ready
                    recipe.ingredients.splice(index, 1); //Removes the item from the array without leaving an empty space.
                    console.log(recipe.ingredients);

                    await updateItem(key, recipe, 'recipeStore');
                    loadItems();
                } //The 'ready' variable will be set again by the loadItems function
            }
            
            async function saveText(form) {
                await recipePromise;
                recipe.text = form['text'].value.replace('<',''); //Gets the text from the form, and removes '<'
                updateItem(key, recipe, 'recipeStore');
            }

            async function addToShoppingList() {
                await recipePromise;
                await addArray(recipe.ingredients, 'shoppingList');
                console.log(recipe.ingredients);
                window.alert("Success");
            }
            async function addChecked(form) {
                await recipePromise;
                const ingredients = recipe.ingredients;
                const items = [];
                for (x of form.elements) {
                    if (x.checked) { //Get the checked items
                        items.push(ingredients[Number(x.name)]);
                    }
                };
                await addArray(items, 'shoppingList'); //Add the items to the shopping list
                console.log(items);
            }
            async function removeChecked(form) {
                await recipePromise;
                const ingredients = recipe.ingredients;
                const indices = [];
                for (x of form.elements) { //Getting the indices of values to be removed
                    if (x.checked) {
                        indices.push(Number(x.name)); //Adds the index to the list
                    }
                }
                indices.sort(function(a, b){return b - a;}) //Sorts the list in reverse
                console.log(indices);
                for (i of indices) { //Removes the elements from the back, so earlier elements won't move
                    ingredients.splice(i, 1);
                }
                await updateItem(key, recipe, 'recipeStore');
                loadItems(); //Reload the list
                
            }
        </script>
    </head>
    <body>
        <nav id="main" class="cf include-html" data-include-src="/c/navbar.html">
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/database/food.html">Fridge</a></li>
                <li><a href="/database/recipes.html">Recipes</a></li>
                <li><a href="/database/shopping.html">Shopping List</a></li>
                <li><a href="/help.html">Help</a></li>            
            </ul>
        </nav>
        <h1 id="recipe-name"></h1>
        <div data-cf class="grid-responsive"><!--Container for the recipe editor and ingredient list-->
            <div>
                <form onsubmit="event.preventDefault(); saveText(this)">
                    <label for="recipe-editor">Recipe</label>
                    <textarea id="recipe-editor" name="text"></textarea>
                    <input type="submit" value="Save">
                    <input type="reset" value="Clear"  onclick="document.getElementById('recipe-editor').innerHTML = '';">
                </form>
            </div><div>
                <form onsubmit="event.preventDefault(); addIngredient(this)" data-cf>
                    <div><!--Will be used to separate different parts of the form-->
                        <label for="name">Ingredient: </label>
                        <input type="text" name="name" id="name">
                    </div><div>
                        <label for="qty">Amount: </label>
                        <input type="number" name="qty" id="qty" min="0" step="0.01">
                        <input type="text" list="unit-select" id="unit" name="unit">
                        <datalist id="unit-select">
                            <option value="">
                            <option value="g">
                            <option value="kg">
                            <option value="L">
                        </datalist>
                    </div>
                    <input type="submit" value="Add Item">
                    <input type="reset" value="Clear Form" data-float="right">
                </form>
                <div class="form">
                    <button data-type="minor" onclick="addToShoppingList()">Add All to Shopping List</button>
                </div>
                <div>
                    <form class="sticky" name="list" id="list" onsubmit="event.preventDefault(); addChecked(this)" data-cf>
                        <input type="submit" data-type="major" value="Add Selected">
                        <input type="button" data-type="minor" data-float="right" value="Remove Selected" onclick="removeChecked(document.getElementById('list'))">
                    </form>
                    <ul id="output"><!--The list of items in the fridge-->
                        <!--Add loading animation-->
                    </ul>
                </div>
            </div>
            <script>
                loadItems();
                loadText();
            </script>
        </div>
        <footer class="cf include-html" data-include-src="/c/footer.html">
            <nav>
                <ul>
                    <li><a href="/index.html">Home</a></li>
                    <li><a href="/database/food.html">Fridge</a></li>
                    <li><a href="/database/recipes.html">Recipes</a></li>
                    <li><a href="/database/shopping.html">Shopping List</a></li>
                    <li><a href="/help.html">Help</a></li>
                </ul>
            </nav>
            <p class="right">
                ©Oliver Glossop, 2023
            </p>
        </footer>
        <script>
            includeHTML();
        </script>
    </body>
</html>